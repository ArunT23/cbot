using cAlgo.API;
using System;

namespace cAlgo
{
    [Robot(TimeZone = TimeZones.UTC, AccessRights = AccessRights.None)]
    public class ScalpingBot : Robot
    {
        private ExponentialMovingAverage ema21;
        private ExponentialMovingAverage ema50;
        private ExponentialMovingAverage ema144;
        private RelativeStrengthIndex rsi;

        protected override void OnStart()
        {
            ema21 = Indicators.ExponentialMovingAverage(MarketSeries.Close, 21);
            ema50 = Indicators.ExponentialMovingAverage(MarketSeries.Close, 50);
            ema144 = Indicators.ExponentialMovingAverage(MarketSeries.Close, 144);
            rsi = Indicators.RelativeStrengthIndex(MarketSeries.Close, 14);
        }

        protected override void OnBar()
        {
            var currentBarOpenTime = MarketSeries.OpenTime.Last(0);

            if (IsLondonSession(currentBarOpenTime) && IsRestrictedTime(currentBarOpenTime))
            {
                if (ema21.Result.HasCrossedAbove(ema144.Result) && ema50.Result.HasCrossedAbove(ema144.Result))
                {
                    if (rsi.Result.Last(1) > 70 && rsi.Result.Last(2) < 70)
                    {
                        // Enter long trade
                        var volume = Symbol.NormalizeVolumeInUnits(Symbol.QuantityToVolumeInUnits(Account.Equity * 0.01, Symbol));
                        var stopLoss = Symbol.Bid - Symbol.PipSize * 0.0025;
                        var takeProfit = Symbol.Bid + (Symbol.Bid - stopLoss) * 2;
                        var result = ExecuteMarketOrder(TradeType.Buy, Symbol, volume, "Long Trade", null, stopLoss, takeProfit);
                        if (result.Error == ErrorCode.NoError)
                            ModifyPosition(result.Position, Symbol.Bid, stopLoss);
                    }
                }
                else if (ema21.Result.HasCrossedBelow(ema144.Result) && ema50.Result.HasCrossedBelow(ema144.Result))
                {
                    if (rsi.Result.Last(1) < 30 && rsi.Result.Last(2) > 30)
                    {
                        // Enter short trade
                        var volume = Symbol.NormalizeVolumeInUnits(Symbol.QuantityToVolumeInUnits(Account.Equity * 0.01, Symbol));
                        var stopLoss = Symbol.Ask + Symbol.PipSize * 0.0025;
                        var takeProfit = Symbol.Ask - (stopLoss - Symbol.Ask) * 2;
                        var result = ExecuteMarketOrder(TradeType.Sell, Symbol, volume, "Short Trade", null, stopLoss, takeProfit);
                        if (result.Error == ErrorCode.NoError)
                            ModifyPosition(result.Position, Symbol.Ask, stopLoss);
                    }
                }
            }
        }

        private bool IsLondonSession(DateTime time)
        {
            // Adjust the time zone if necessary
            var londonTimeZone = TimeZoneInfo.FindSystemTimeZoneById("Europe/London");
            var londonSessionStart = new DateTime(time.Year, time.Month, time.Day, 8, 0, 0).AddMinutes(-1);
            var londonSessionEnd = new DateTime(time.Year, time.Month, time.Day, 16, 0, 0).AddMinutes(1);

            var localTime = TimeZoneInfo.ConvertTimeFromUtc(time, londonTimeZone);

            return localTime >= londonSessionStart && localTime <= londonSessionEnd;
        }

        private bool IsRestrictedTime(DateTime time)
        {
            var firstHourStart = new DateTime(time.Year, time.Month, time.Day, 8, 0, 0).AddMinutes(-1);
            var firstHourEnd = new DateTime(time.Year, time.Month, time.Day, 9, 0, 0).AddMinutes(1);

            var finalHourStart = new DateTime(time.Year, time.Month, time.Day, 15, 0, 0).AddMinutes(-1);
            var finalHourEnd = new DateTime(time.Year, time.Month, time.Day, 16, 0, 0).AddMinutes(1);

            var localTime = TimeZoneInfo.ConvertTimeFromUtc(time, TimeZoneInfo.Local);

            return (localTime >= firstHourStart && localTime <= firstHourEnd) || (localTime >= finalHourStart && localTime <= finalHourEnd);
        }

        protected override void OnTick()
        {
            foreach (var position in Positions)
            {
                if (position.StopLoss != null && position.Pips >= Symbol.PipSize * 10)
                {
                    var breakEvenPrice = position.EntryPrice;
                    if (position.TradeType == TradeType.Buy)
                        breakEvenPrice += Symbol.PipSize * 0.0025;
                    else if (position.TradeType == TradeType.Sell)
                        breakEvenPrice -= Symbol.PipSize * 0.0025;

                    if (position.TradeType == TradeType.Buy && Symbol.Bid >= breakEvenPrice)
                        ModifyPosition(position, breakEvenPrice, position.TakeProfit);
                    else if (position.TradeType == TradeType.Sell && Symbol.Ask <= breakEvenPrice)
                        ModifyPosition(position, breakEvenPrice, position.TakeProfit);
                }
            }
        }
    }
}
